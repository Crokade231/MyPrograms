SELECT
kocode,
count(case when JBYELEFLG = 'Y' then foracid end),
count(case when SBYELEFLG = 'Y' then foracid end)
from
(
select
sol.division_name,
sol.region_name,
sol.sol_id,
sol.br_code,
gam.cust_id,
gam.acid,
gam.foracid,
gam.acct_name,
gam.schm_code,
cor.free_text_14 kocode,
MAX(case when months_between( cast('$(vToDate)' as timestamp), CAST(cmg.cust_dob AS TIMESTAMP))/12 >= 18 
and months_between( cast('$(vToDate)' as timestamp), CAST(cmg.cust_dob AS TIMESTAMP))/12 <= 50 then 'Y' ELSE 'N' end) JBYELEFLG,
MAX(case when months_between( cast('$(vToDate)' as timestamp), CAST(cmg.cust_dob AS TIMESTAMP))/12 >= 18 
and months_between( cast('$(vToDate)' as timestamp), CAST(cmg.cust_dob AS TIMESTAMP))/12 <= 70 then 'Y' ELSE 'N' end) SBYELEFLG


from eds.general_acct_mast_table gam
inner join eds.service_outlet_table sol on (sol.sol_id = gam.sol_id)
inner join eds.accounts cmg on (cmg.orgkey = gam.cust_id)
inner join eds.coreinterface cor on (cor.orgkey = gam.cust_id)

left join (select distinct cust_id,'Y' AS FLG from eds.c_pmjby_tbl where insurer_identifier = 'PMJJBY' and del_flg <> 'Y'
and policy_valid = '2022-05-31')JBY ON (JBY.cust_id = GAM.cust_id)

left join (select distinct cust_id,'Y' AS FLG from eds.c_pmjby_tbl where insurer_identifier = 'PMSBY' and del_flg <> 'Y'
and policy_valid = '2022-05-31')SBY ON (SBY.cust_id = GAM.cust_id)

WHERE
gam.schm_type = 'SBA'
and gam.schm_code in ('SB150','SB124')
AND gam.acct_cls_flg <> 'Y'
and gam.del_flg <> 'Y'
and gam.foracid not like '%ZZ%'
and months_between( cast('$(vToDate)' as timestamp), CAST(cmg.cust_dob AS TIMESTAMP))/12 >= 18 
and months_between( cast('$(vToDate)' as timestamp), CAST(cmg.cust_dob AS TIMESTAMP))/12 <= 70
and cor.free_text_14 is not null

group by
sol.division_name,
sol.region_name,
sol.sol_id,
sol.br_code,
gam.cust_id,
gam.acid,
gam.foracid,
gam.acct_name,
gam.schm_code,
COR.FREE_TEXT_14
)KOIDWISE
group by
kocode